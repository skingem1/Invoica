{
  "tasks": [
    {
      "id": "BE-260",
      "title": "API key generation pure function tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "context": "Create unit tests for the pure functions in backend/src/services/api-keys.ts. Only test functions that need NO database or bcrypt. The file has these constants: API_KEY_PREFIX = 'sk_', API_KEY_LENGTH = 32. Test these exports: generateApiKey(): string — returns 'sk_' + 64 hex chars (32 bytes as hex). getKeyPrefix(apiKey: string): string — returns 8 chars after 'sk_' prefix (substring from index 3 to 11). validateApiKeyFormat(apiKey: string): boolean — validates regex ^sk_[a-f0-9]{64}$. Write 5 tests: (1) generateApiKey starts with 'sk_', (2) generateApiKey has length 67 (3 prefix + 64 hex), (3) generateApiKey produces unique keys (call twice, expect not equal), (4) getKeyPrefix returns first 8 hex chars after prefix, (5) validateApiKeyFormat returns true for valid key and false for 'invalid'. Import { generateApiKey, getKeyPrefix, validateApiKeyFormat } from '../api-keys'. Use describe('api-keys/generation'). Max 30 lines.",
      "deliverables": {
        "code": [
          "backend/src/services/__tests__/api-keys-generation.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/services/__tests__/api-keys-generation.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 95,
          "summary": "Dual-approved: Claude (95/100) + Codex (95/100)",
          "issues": [
            {
              "severity": "low",
              "file": "backend/src/services/__tests__/api-keys-generation.test.ts",
              "description": "Could add edge case test for validateApiKeyFormat with malformed keys (wrong length, invalid chars) for more comprehensive coverage"
            }
          ],
          "strengths": [
            "Perfect adherence to task specification - exactly 5 tests as requested",
            "Clean, readable test structure with descriptive test names",
            "Proper imports and describe block naming as specified",
            "Tests cover all the pure functions mentioned in the spec",
            "Efficient test implementation under 30 lines as required",
            "Good use of generated keys for realistic testing scenarios",
            "Proper assertions for string operations and boolean validations",
            "No unnecessary abstractions or over-engineering",
            "Covers all specified test scenarios including prefix, length, uniqueness, substring extraction, and format validation.",
            "Adheres to the max 30-line requirement and uses the correct describe block name.",
            "Imports from the correct relative path without extraneous dependencies.",
            "No markdown fences or invalid syntax present."
          ]
        }
      }
    },
    {
      "id": "BE-261",
      "title": "API key schema validation tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "context": "Create unit tests for the Zod schema and metadata function in backend/src/services/api-keys.ts. Test these exports: createApiKeySchema — a z.object with fields: customerId (string min 1), customerEmail (string email), name (string min 1 max 100), tier (string default 'free'), plan (string default 'basic'), permissions (array of strings default []), expiresInDays (number min 1 max 365 optional). getApiKeyMetadata(apiKey: ApiKey): Omit<ApiKey, 'keyHash'> — removes keyHash from ApiKey object, keeps all other fields. Write 6 tests: (1) schema accepts valid input with all fields, (2) schema rejects missing customerId, (3) schema rejects invalid email, (4) schema defaults tier to 'free' when not provided, (5) schema defaults permissions to empty array, (6) getApiKeyMetadata removes keyHash but keeps other fields. Import { createApiKeySchema, getApiKeyMetadata, ApiKey } from '../api-keys'. Use describe('api-keys/schema'). Max 45 lines.",
      "deliverables": {
        "code": [
          "backend/src/services/__tests__/api-keys-schema.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/services/__tests__/api-keys-schema.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 91,
          "summary": "Dual-approved: Claude (92/100) + Codex (90/100)",
          "issues": [
            {
              "severity": "low",
              "file": "backend/src/services/__tests__/api-keys-schema.test.ts",
              "description": "Could add more specific error message assertions in rejection tests to verify exact validation failures"
            },
            {
              "severity": "low",
              "file": "backend/src/services/__tests__/api-keys-schema.test.ts",
              "description": "Missing test for plan default value ('basic') as mentioned in schema spec"
            }
          ],
          "strengths": [
            "All 6 required test cases implemented correctly",
            "Proper TypeScript typing with ApiKey interface usage",
            "Clean test structure with descriptive test names matching requirements",
            "Correct import statements as specified",
            "Uses proper Jest expectations and assertions",
            "File length (45 lines) meets the max requirement exactly",
            "Tests both positive and negative validation cases",
            "Proper use of describe block with specified name 'api-keys/schema'",
            "Covers all specified test cases including valid input, schema rejections, and default values.",
            "Correctly tests getApiKeyMetadata to remove keyHash and preserve other fields.",
            "Matches the spec’s naming and import paths.",
            "Under 45 lines and free of markdown fences or invalid syntax."
          ]
        }
      }
    },
    {
      "id": "BE-262",
      "title": "Ledger config service tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "context": "Create unit tests for backend/src/services/ledger/config.ts. The file imports DEFAULT_LEDGER_CONFIG from ./types which is { reservationExpirySeconds: 60, maxRetryAttempts: 3, retryDelayMs: 100 }. Exports: getLedgerConfig(): LedgerConfig — returns copy of current config. setLedgerConfig(config: Partial<LedgerConfig>): void — merges partial config into current. resetLedgerConfig(): void — resets to DEFAULT_LEDGER_CONFIG. initLedgerConfigFromEnv(): void — reads LEDGER_RESERVATION_EXPIRY_SECONDS, LEDGER_MAX_RETRY_ATTEMPTS, LEDGER_RETRY_DELAY_MS from process.env with defaults 60, 3, 100. Write 5 tests: (1) getLedgerConfig returns default values (reservationExpirySeconds=60, maxRetryAttempts=3, retryDelayMs=100), (2) setLedgerConfig updates partial values (set retryDelayMs to 200, check others unchanged), (3) resetLedgerConfig restores defaults after setLedgerConfig, (4) getLedgerConfig returns a copy (mutating result does not affect internal state), (5) initLedgerConfigFromEnv reads env vars (set process.env.LEDGER_MAX_RETRY_ATTEMPTS='5' then call initLedgerConfigFromEnv, check maxRetryAttempts=5). Call resetLedgerConfig() in beforeEach. Import { getLedgerConfig, setLedgerConfig, resetLedgerConfig, initLedgerConfigFromEnv } from '../config'. Use describe('ledger/config'). Max 40 lines.",
      "deliverables": {
        "code": [
          "backend/src/services/ledger/__tests__/config.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/services/ledger/__tests__/config.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 91,
          "summary": "Dual-approved: Claude (92/100) + Codex (90/100)",
          "issues": [
            {
              "severity": "low",
              "file": "backend/src/services/ledger/__tests__/config.test.ts",
              "description": "Missing cleanup of environment variable in beforeEach - could cause test pollution if other env vars are set"
            },
            {
              "severity": "low",
              "file": "backend/src/services/ledger/__tests__/config.test.ts",
              "description": "Could add afterEach to clean up all LEDGER_* env vars for better test isolation"
            }
          ],
          "strengths": [
            "All 5 required test cases implemented correctly",
            "Proper beforeEach setup with resetLedgerConfig()",
            "Correct import statement matching task spec",
            "Tests validate exact expected behavior (partial updates, immutability, env var reading)",
            "Clean, readable test structure with descriptive names",
            "Proper cleanup of env var in the env test case",
            "Under 40 lines as required (32 lines)",
            "No code fences or syntax issues",
            "Tests cover edge cases like mutation protection and partial config updates",
            "Covers all five specified test cases",
            "Uses beforeEach to reset state for isolation",
            "Tests immutability of returned config object",
            "Cleans up environment variable after the test"
          ]
        }
      }
    },
    {
      "id": "BE-263",
      "title": "Ledger types enums and constants tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "context": "Create unit tests for backend/src/services/ledger/types.ts. The file exports: AccountType enum with ASSET='ASSET', LIABILITY='LIABILITY', EQUITY='EQUITY', REVENUE='REVENUE', EXPENSE='EXPENSE'. EntryDirection enum with DEBIT='DEBIT', CREDIT='CREDIT'. BudgetLevel enum with AGENT='AGENT', TEAM='TEAM', DEPARTMENT='DEPARTMENT'. DEFAULT_LEDGER_CONFIG constant with { reservationExpirySeconds: 60, maxRetryAttempts: 3, retryDelayMs: 100 }. Write 5 tests: (1) AccountType has 5 values (ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE), (2) EntryDirection has DEBIT and CREDIT values, (3) BudgetLevel has AGENT, TEAM, DEPARTMENT values, (4) DEFAULT_LEDGER_CONFIG.reservationExpirySeconds equals 60, (5) DEFAULT_LEDGER_CONFIG has exactly 3 keys. Import { AccountType, EntryDirection, BudgetLevel, DEFAULT_LEDGER_CONFIG } from '../types'. Use describe('ledger/types'). Max 30 lines.",
      "deliverables": {
        "code": [
          "backend/src/services/ledger/__tests__/types.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/services/ledger/__tests__/types.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 93,
          "summary": "Dual-approved: Claude (95/100) + Codex (90/100)",
          "issues": [
            {
              "severity": "low",
              "file": "backend/src/services/ledger/__tests__/types.test.ts",
              "description": "Could use more explicit array ordering checks, but Object.values() order is consistent in modern JS engines"
            }
          ],
          "strengths": [
            "Exactly matches task specification - 5 tests as requested",
            "Clean, readable test structure with descriptive test names",
            "Proper imports from relative path '../types'",
            "Correct describe block naming 'ledger/types'",
            "Under 30 lines as required (16 lines total)",
            "No code fences or invalid syntax",
            "Tests cover all exported types and constants",
            "Uses appropriate Jest matchers (toEqual, toBe, toHaveLength)",
            "No unnecessary abstractions or overengineering",
            "Tests cover all specified cases: enum values and default config properties.",
            "File is under 30 lines and uses the correct describe block.",
            "No markdown fences or syntax issues.",
            "Jest assertions are clear and correctly implemented."
          ]
        }
      }
    },
    {
      "id": "BE-264",
      "title": "Idempotency key extractor tests (BE-254 fix)",
      "agent": "backend-core",
      "status": "done",
      "priority": "high",
      "dependencies": [],
      "context": "Create unit tests for the getIdempotencyKey pure function from backend/src/middleware/idempotency.ts. This is a targeted fix for BE-254 which failed in Week 31. Only test getIdempotencyKey — do NOT test idempotencyMiddleware. The function: getIdempotencyKey(req: Request): string | undefined — reads req.headers['idempotency-key']. If string, returns it. If array with length > 0, returns first element. Otherwise returns undefined. Write 4 tests: (1) returns string header value when present, (2) returns first element when header is array, (3) returns undefined when header missing, (4) returns undefined when header is empty array. Mock req as { headers: { 'idempotency-key': value } } with 'as any'. Import { getIdempotencyKey } from '../idempotency'. Use describe('getIdempotencyKey'). Max 25 lines.",
      "deliverables": {
        "code": [
          "backend/src/middleware/__tests__/idempotency-key.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/middleware/__tests__/idempotency-key.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 93,
          "summary": "Dual-approved: Claude (95/100) + Codex (90/100)",
          "issues": [],
          "strengths": [
            "Perfect adherence to task spec - exactly 4 tests as requested covering all specified scenarios",
            "Proper TypeScript typing with 'as unknown as Request' casting as specified",
            "Clean, readable test descriptions that match requirements exactly",
            "Correct import path and describe block naming",
            "Concise implementation at 18 lines, well under the 25-line limit",
            "Proper Jest assertions using toBe() and toBeUndefined()",
            "Tests cover all edge cases: string value, array with multiple elements, missing header, empty array",
            "No unnecessary abstractions or extra functionality - stays focused on the pure function",
            "Covers all four required test cases",
            "Concise and stays under the 25-line limit",
            "Follows the prescribed describe/it structure and naming conventions"
          ]
        }
      }
    },
    {
      "id": "BE-265",
      "title": "Error handler v2 middleware tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "context": "Create unit tests for backend/src/middleware/error-handler-v2.ts. Read the file to understand its exports. The v2 error handler exports errorHandlerV2 middleware function that takes (err, req, res, next) — standard Express error middleware with 4 args. It should: set status code from err.statusCode or default to 500, return JSON { error: { message, code, statusCode } }, log errors. Write 4 tests: (1) returns 500 for generic Error with message, (2) returns custom statusCode when err has statusCode property, (3) response has error.message and error.statusCode fields, (4) calls no next() — error handler is terminal. Mock req as {}, mock res with status().json() chain, mock next as jest.fn(). Import from '../error-handler-v2'. Use describe('error-handler-v2'). Max 35 lines.",
      "deliverables": {
        "code": [
          "backend/src/middleware/__tests__/error-handler-v2.test.ts"
        ]
      },
      "output": {
        "files": [
          "backend/src/middleware/__tests__/error-handler-v2.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 92,
          "summary": "CEO resolved conflict (Claude approved, Codex rejected): **REJECT — Codex is correct on both counts**\n\nThe markdown code fence (````typescript`) at the start makes this invalid TypeScript syntax that won't compile. That's a critical blocker, not a nitpick. The line count violation (exceeding 35 lines) directly contradicts the task spec requirement.\n\nClaud",
          "issues": [
            {
              "severity": "critical",
              "file": "backend/src/middleware/__tests__/error-handler-v2.test.ts",
              "description": "File starts with a markdown code fence (```typescript), which is invalid syntax in source files."
            },
            {
              "severity": "high",
              "file": "backend/src/middleware/__tests__/error-handler-v2.test.ts",
              "description": "Test file exceeds the maximum of 35 lines as specified in the task spec."
            }
          ],
          "strengths": [
            "Meets all 4 test requirements exactly as specified",
            "Proper Jest mocking setup with beforeEach cleanup",
            "Tests both generic Error objects and custom error objects with statusCode",
            "Verifies terminal behavior (no next() call) as required",
            "Clean describe block structure with descriptive test names",
            "Stays within 35-line limit (34 lines)",
            "Proper TypeScript imports and typing",
            "Good separation of concerns - each test focuses on one behavior",
            "Proper assertion patterns using Jest matchers"
          ]
        }
      }
    },
    {
      "id": "SDK-190",
      "title": "Complete client v2 tests",
      "agent": "backend-core",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "context": "Create unit tests for sdk/typescript/src/complete-client-v2.ts. The file exports a class or factory that creates a fully-configured SDK client. Test the constructor/factory and basic properties only — do NOT test methods that make HTTP calls. Write 5 tests: (1) can create instance (no throw), (2) instance has invoices property, (3) instance has settlements property, (4) instance has apiKeys property, (5) instance has webhooks property. If the export is a class, use new CompleteClientV2({ baseUrl: 'http://test.local', apiKey: 'sk_test123' }). If the export is a factory function, call it with same config. Import the default or named export from '../src/complete-client-v2'. Use describe('CompleteClientV2'). Max 30 lines.",
      "deliverables": {
        "code": [
          "sdk/typescript/tests/complete-client-v2.test.ts"
        ]
      },
      "output": {
        "files": [
          "sdk/typescript/tests/complete-client-v2.test.ts"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 95,
          "summary": "Dual-approved: Claude (95/100) + Codex (95/100)",
          "issues": [
            {
              "severity": "low",
              "file": "sdk/typescript/tests/complete-client-v2.test.ts",
              "description": "Could add type assertion to verify properties are not undefined, but this is minor since toHaveProperty checks existence"
            }
          ],
          "strengths": [
            "Exactly follows task spec - 5 tests for the 5 required properties",
            "Clean test structure with proper describe block",
            "Correct import statement and constructor usage",
            "No HTTP calls or method testing as explicitly requested",
            "Under 30 lines as required (20 lines total)",
            "Proper Jest syntax with expect().not.toThrow() and toHaveProperty()",
            "Reuses config object efficiently",
            "No code fences or invalid syntax",
            "Covers all five specified tests: instance creation, invoices, settlements, apiKeys, and webhooks properties.",
            "Follows the requested structure with describe('CompleteClientV2') and individual it blocks.",
            "Uses the correct instantiation pattern for a class-based export.",
            "Keeps the file concise (under 30 lines) with no extraneous code.",
            "No markdown fences present—valid TypeScript syntax."
          ]
        }
      }
    },
    {
      "id": "FE-203",
      "title": "Docs SDK overview page",
      "agent": "frontend",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "context": "Create an SDK overview documentation page at frontend/app/docs/sdk-overview/page.tsx. This is a Next.js page component (default export). Structure: (1) h1 'SDK Overview' with text-3xl font-bold mb-6, (2) p with text-gray-600 mb-8 intro text about TypeScript SDK for Invoica platform, (3) Section 'Supported Languages' with h2 text-xl font-semibold mb-4 — div grid grid-cols-2 gap-4 with 4 cards: TypeScript (Available), Python (Coming Soon), Go (Planned), Rust (Planned). Each card: div border rounded-lg p-4 with h3 font-medium and p text-sm text-gray-500 with status, (4) Section 'Key Features' with h2 — ul list-disc pl-6 with 5 li items: 'Type-safe API client', 'Automatic retry with exponential backoff', 'Rate limiting built-in', 'Webhook signature verification', 'Comprehensive error handling'. (5) Section 'Requirements' with h2 — p text-gray-600 explaining Node.js 18+ and TypeScript 5+. Use Tailwind: max-w-3xl. Export default function SdkOverviewPage(). Max 55 lines total.",
      "deliverables": {
        "code": [
          "frontend/app/docs/sdk-overview/page.tsx"
        ]
      },
      "output": {
        "files": [
          "frontend/app/docs/sdk-overview/page.tsx"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 93,
          "summary": "Dual-approved: Claude (95/100) + Codex (90/100)",
          "issues": [
            {
              "severity": "low",
              "file": "frontend/app/docs/sdk-overview/page.tsx",
              "description": "Minor branding inconsistency - uses 'Invoica' instead of 'Countable' platform name, but this may be intentional for SDK branding"
            }
          ],
          "strengths": [
            "Exact adherence to task specification - all required sections, classes, and structure implemented correctly",
            "Clean TypeScript with proper default export function naming",
            "Semantic HTML structure with proper heading hierarchy (h1 > h2 > h3)",
            "Responsive grid layout with proper Tailwind classes",
            "Well-organized sections with consistent spacing (mb-8, mb-4)",
            "Accessible markup with proper list semantics",
            "Concise implementation at 44 lines, well under the 55-line limit",
            "No unnecessary abstractions or over-engineering",
            "Professional copy that explains the SDK value proposition clearly",
            "Accurate implementation of headings, sections and list items as specified",
            "Tailwind classes used appropriately",
            "Code is concise and free of syntax errors"
          ]
        }
      }
    },
    {
      "id": "FE-204",
      "title": "Docs webhooks guide page",
      "agent": "frontend",
      "status": "done",
      "priority": "medium",
      "dependencies": [],
      "context": "Create a webhooks guide documentation page at frontend/app/docs/webhooks/page.tsx. This is a Next.js page component (default export). Structure: (1) h1 'Webhooks' with text-3xl font-bold mb-6, (2) p with text-gray-600 mb-8 intro about receiving real-time event notifications, (3) Section 'Supported Events' with h2 text-xl font-semibold mb-4 — div with 6 event items. Each item: div flex items-center gap-3 py-2 border-b with span font-mono text-sm bg-gray-100 px-2 py-1 rounded for event name and span text-gray-600 for description. Events: invoice.created 'New invoice generated', invoice.paid 'Payment received', invoice.settled 'Settlement completed', invoice.failed 'Invoice payment failed', settlement.confirmed 'On-chain confirmation', settlement.failed 'Settlement failed'. (4) Section 'Signature Verification' with h2 — p text-gray-600 explaining HMAC-SHA256 signature in X-Countable-Signature header, (5) Section 'Retry Policy' with h2 — p text-gray-600 explaining exponential backoff with max 3 retries. Use Tailwind: max-w-3xl. Export default function WebhooksPage(). Max 60 lines total.",
      "deliverables": {
        "code": [
          "frontend/app/docs/webhooks/page.tsx"
        ]
      },
      "output": {
        "files": [
          "frontend/app/docs/webhooks/page.tsx"
        ],
        "commit": "",
        "model": "MiniMax-M2.5",
        "review": {
          "verdict": "APPROVED",
          "score": 94,
          "summary": "Dual-approved: Claude (92/100) + Codex (95/100)",
          "issues": [
            {
              "severity": "low",
              "file": "frontend/app/docs/webhooks/page.tsx",
              "description": "Unnecessary React import - Next.js 13+ with app router doesn't require explicit React imports"
            },
            {
              "severity": "low",
              "file": "frontend/app/docs/webhooks/page.tsx",
              "description": "Could benefit from semantic HTML elements like <section> tags for better accessibility"
            }
          ],
          "strengths": [
            "Meets all task specifications exactly - correct structure, styling, and content",
            "Clean TypeScript with proper typing and no 'any' usage",
            "Efficient use of map() for event rendering with proper key props",
            "Proper Tailwind classes applied as specified",
            "Well-organized code structure with clear separation of concerns",
            "Stays within 60-line limit (actual: ~45 lines)",
            "No code fences or invalid syntax",
            "Responsive design with max-width container",
            "Good semantic naming for events array and component",
            "Faithfully implements all required sections and Tailwind classes",
            "Dynamically renders the list of supported events",
            "Well-structured and concise code under the 60-line limit",
            "No invalid syntax or markdown fences in source"
          ]
        }
      }
    }
  ]
}